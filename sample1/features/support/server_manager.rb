# copy from https://github.com/vbanthia/appium-jenkins-demo/blob/master/spec/support/server_manager.rb
module ServerManager
  class << self
    def appium_configuration
      @appium_conf ||= ::AppiumServerConfiguration.new
      yield(@appium_conf) if block_given?
      @appium_conf
    end

    def start_appium_server
      kill_process_at_port(appium_configuration.port)

      cmd = appium_configuration.appium_path
      cmd << Array(appium_configuration.server_flags).map { |flag| " --#{flag}" }.join
      cmd << " --port #{appium_configuration.port}"
      cmd << appium_configuration.server_args.map { |k, v| " --#{k} #{v}" }.join(' ')

      pid = spawn(cmd, out: '/dev/null')
      Process.detach(pid)

      sleep 3
    end

    def kill_appium_server
      kill_process_at_port(appium_configuration.port)
    end

    private

    def kill_process_at_port(port)
      process_ids = `lsof -t -i:#{ port }`.split("\n")
      process_ids.each do |process_id|
        `kill #{ process_id }`
      end
    end
  end
end

class AppiumServerConfiguration
  attr_writer :appium_path, :port, :server_flags, :server_args

  def appium_path
    # Assuming, Appium is installed locally using npm.
    @appium_path ||= 'node_modules/.bin/appium'
  end

  def port
    @port ||= '4723'
  end

  def server_flags
    @server_flags ||= []
  end

  def server_args
    @server_args ||= {}
  end
end
